<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Game 3 - Car Escape Rush Hour</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            overflow-x: hidden;
            touch-action: pan-y;
        }

        .container {
            background: white;
            border-radius: 0;
            box-shadow: none;
            padding: 15px;
            max-width: 100vw;
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 768px) {
            .container {
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-width: 500px;
                min-height: auto;
            }
        }

        h1 {
            color: #1f2937;
            text-align: center;
            margin-bottom: 15px;
            font-size: 22px;
            font-weight: 700;
        }

        .info-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            gap: 8px;
        }

        .info-item {
            background: #f3f4f6;
            padding: 8px 12px;
            border-radius: 10px;
            flex: 1;
            text-align: center;
        }

        .info-label {
            font-size: 11px;
            color: #6b7280;
            margin-bottom: 3px;
            font-weight: 500;
        }

        .info-value {
            font-size: 20px;
            font-weight: bold;
            color: #1f2937;
        }

        #gameBoard {
            width: calc(100vw - 30px);
            height: calc(100vw - 30px);
            max-width: 360px;
            max-height: 360px;
            background: #374151;
            margin: 0 auto 15px;
            position: relative;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 2px;
            padding: 2px;
            touch-action: none;
        }

        @media (min-width: 768px) {
            #gameBoard {
                width: 360px;
                height: 360px;
            }
        }

        .grid-cell {
            background: #e5e7eb;
            border-radius: 4px;
        }

        .car {
            position: absolute;
            border-radius: 8px;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            transition: transform 0.1s, box-shadow 0.1s;
            user-select: none;
            touch-action: none;
            z-index: 1;
        }

        .car:active {
            cursor: grabbing;
            transform: scale(1.08);
            box-shadow: 0 6px 16px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .car.dragging {
            opacity: 0.9;
            z-index: 10;
        }

        .car.target {
            background: #ef4444;
            color: white;
        }

        .car.horizontal {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .car.vertical {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .exit {
            position: absolute;
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            background: #fbbf24;
            border-radius: 0 8px 8px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            z-index: 0;
        }

        button {
            width: 100%;
            padding: 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 10px;
            touch-action: manipulation;
        }

        button:active {
            background: #5568d3;
            transform: scale(0.98);
        }

        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
/* // !-- Quiz Submission --> */
        .quiz-option {
            background: #f3f4f6;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            font-size: 15px;
            touch-action: manipulation;
        }
/* // !-- Quiz Submission --> */
        .quiz-option:active {
            transform: scale(0.98);
        }
/* // !-- Quiz Submission --> */
        .quiz-option.selected {
            background: #dbeafe;
            border-color: #3b82f6;
        }
/* // !-- Quiz Submission --> */
        .quiz-option.correct {
            background: #d1fae5;
            border-color: #10b981;
        }
/* // !-- Quiz Submission --> */
        .quiz-option.incorrect {
            background: #fee2e2;
            border-color: #ef4444;
        }
/* // !-- Quiz Submission --> */
        .error-message {
            color: #ef4444;
            font-size: 14px;
            margin-top: 10px;
        }
        #endGameBtn {
            background: #ef4444;
            margin-top: 15px;
        }

        #endGameBtn:active {
            background: #dc2626;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px 25px;
            border-radius: 20px;
            max-width: 90%;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }

        @media (min-width: 768px) {
            .modal-content {
                max-width: 500px;
                padding: 40px;
            }
        }

        .modal-content h2 {
            color: #1f2937;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .modal-content p {
            color: #6b7280;
            margin-bottom: 15px;
            line-height: 1.6;
            font-size: 15px;
        }

        .modal-content ul {
            text-align: left;
            margin: 15px 0;
            padding-left: 20px;
        }

        .modal-content li {
            color: #374151;
            margin-bottom: 8px;
            line-height: 1.5;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #374151;
            font-weight: 600;
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .start-button {
            background: #10b981;
            padding: 14px 40px;
            font-size: 17px;
            margin-top: 20px;
        }

        .start-button:active {
            background: #059669;
        }

        .game-over-modal .modal-content {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        }

        .success-icon {
            font-size: 56px;
            margin-bottom: 15px;
        }

        .round-complete {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #10b981;
            color: white;
            padding: 20px 40px;
            border-radius: 12px;
            font-size: 22px;
            font-weight: bold;
            z-index: 999;
            animation: celebrate 0.5s ease-out;
            display: none;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }

        @keyframes celebrate {
            0% { transform: translate(-50%, -50%) scale(0); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        /* Prevent pull-to-refresh on mobile */
        body {
            overscroll-behavior-y: contain;
        }
    </style>
</head>
<body>
     <!-- // !-- Quiz Submission -->
    <!-- Quiz Modal --> 
    <div id="quizModal" class="modal active">
        <div class="modal-content">
            <h2>ðŸ§  Quick Quiz</h2>
            <p style="font-size: 16px; font-weight: 600; color: #1f2937; margin: 20px 0;">
                Under the historic east identity corridor, there will be a new public space within ____ South integrated development. (Fill in the blank)
            </p>
            <div class="quiz-option" onclick="selectAnswer('A')">
                <strong>(A)</strong> Katong
            </div>
            <div class="quiz-option" onclick="selectAnswer('B')">
                <strong>(B)</strong> Siglap
            </div>
            <div class="quiz-option" onclick="selectAnswer('C')">
                <strong>(C)</strong> Changi Road
            </div>
            <div class="quiz-option" onclick="selectAnswer('D')">
                <strong>(D)</strong> Geylang
            </div>
            <div id="quizError" class="error-message" style="display: none;"></div>
            <button class="start-button" onclick="submitQuiz()">SUBMIT ANSWER</button>
        </div>
    </div>

    <!-- Player Info Modal -->
    <div id="playerInfoModal" class="modal">
        <div class="modal-content">
            <h2>ðŸš— Welcome to Car Escape Rush Hour</h2>
            <div style="text-align: left; margin: 20px 0;">
                <div class="form-group">
                    <label for="modalPlayerName">Name *</label>
                    <input type="text" id="modalPlayerName" required placeholder="Enter your name">
                </div>
                <div class="form-group">
                    <label for="modalPlayerDepartment">Team *</label>
                    <input type="text" id="modalPlayerDepartment" required placeholder="Enter your Team">
                </div>
            </div>
            <button class="start-button" onclick="showInstructions()">NEXT</button>
        </div>
    </div>

    <!-- Instruction Modal -->
    <div id="instructionModal" class="modal">
        <div class="modal-content">
            <h2>ðŸš— Car Escape Rush Hour</h2>
            <p><strong>How to Play:</strong></p>
            <ul>
                <li>Drag cars horizontally or vertically to clear a path</li>
                <li>Move the <strong style="color: #ef4444;">RED CAR</strong> to the exit (â†’)</li>
                <li>Complete as many puzzles as you can in 60 seconds</li>
            </ul>
            <p><strong>Scoring:</strong></p>
            <ul>
                <li>Maximum: 10 rounds</li>
                <li>Score = Number of rounds completed</li>
                <li>Time limit: 60 seconds total</li>
            </ul>
            <p><strong>Controls:</strong></p>
            <ul>
                <li>Blue cars ðŸš™: Move horizontally (left/right)</li>
                <li>Green cars ðŸš•: Move vertically (up/down)</li>
                <li>Red car ðŸš—: Get it to the exit!</li>
            </ul>
            <button class="start-button" onclick="startGame()">START GAME</button>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div id="gameOverModal" class="modal game-over-modal">
        <div class="modal-content">
            <div class="success-icon">ðŸŽ‰</div>
            <h2 id="gameOverTitle">Game Over</h2>
            <p id="gameOverMessage"></p>
            <button class="start-button" onclick="submitScoreFromModal()">SEND SCORE</button>
        </div>
    </div>

    <!-- Round Complete Notification -->
    <div id="roundComplete" class="round-complete">
        ðŸŽ‰ Round Complete! ðŸŽ‰
    </div>

    <div class="container">
        <h1>ðŸš— Car Escape Rush Hour</h1>

        <div class="info-bar">
            <div class="info-item">
                <div class="info-label">Timer</div>
                <div class="info-value" id="timer">60</div>
            </div>
            <div class="info-item">
                <div class="info-label">Round</div>
                <div class="info-value" id="round">1/10</div>
            </div>
            <div class="info-item">
                <div class="info-label">Moves</div>
                <div class="info-value" id="moves">0</div>
            </div>
        </div>

        <div id="gameBoard">
            <div class="exit">â†’</div>
        </div>

        <button id="endGameBtn" onclick="endGameEarly()" style="display: none;">
            END GAME & SUBMIT SCORE
        </button>
    </div>

    <script>
        // Configuration
        const GRID_SIZE = 6;
        const TIME_LIMIT = 60;
        const MAX_ROUNDS = 10;
        
        // âš ï¸ IMPORTANT: Replace this with your actual Apps Script URL
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby3R1SNGK2aURjm3Ft-Dn5uQBuqwvJ85NJRjxBqrkg5kJ_Kq7m6_r9nIfT6XP3yTRnP/exec';

        let CELL_SIZE = 60; // Will be calculated dynamically
        let currentRound = 1;
        let score = 0;
        let totalMoves = 0;
        let roundMoves = 0;
        let timer = TIME_LIMIT;
        let timerInterval;
        let gameActive = false;
        let gameStarted = false;
        let playerName = '';
        let playerDepartment = '';
        
        let cars = [];
        let draggedCar = null;
        let dragStartPos = null;
        let currentTouchId = null;

        // Calculate cell size based on board dimensions
        function calculateCellSize() {
            const board = document.getElementById('gameBoard');
            const boardWidth = board.offsetWidth;
            CELL_SIZE = (boardWidth - 4) / GRID_SIZE; // Subtract padding
            
            // Update exit height
            const exit = board.querySelector('.exit');
            if (exit) {
                exit.style.height = (CELL_SIZE - 2) + 'px';
            }
        }

        
        // !-- Quiz Submission -->
        function selectAnswer(answer) {
            selectedQuizAnswer = answer;
            document.querySelectorAll('.quiz-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            event.target.closest('.quiz-option').classList.add('selected');
            document.getElementById('quizError').style.display = 'none';
        }


        // !-- Quiz Submission -->
        function submitQuiz() {
            if (!selectedQuizAnswer) {
                const errorDiv = document.getElementById('quizError');
                errorDiv.textContent = 'Please select an answer';
                errorDiv.style.display = 'block';
                return;
            }

            const options = document.querySelectorAll('.quiz-option');
            
            if (selectedQuizAnswer === 'B') {
                // Correct answer
                options[1].classList.add('correct');
                setTimeout(() => {
                    document.getElementById('quizModal').classList.remove('active');
                    document.getElementById('playerInfoModal').classList.add('active');
                }, 1000);
            } else {
                // Incorrect answer - user must try again
                const selectedIndex = selectedQuizAnswer === 'A' ? 0 : selectedQuizAnswer === 'C' ? 2 : 3;
                options[selectedIndex].classList.add('incorrect');
                
                const errorDiv = document.getElementById('quizError');
                errorDiv.textContent = 'Incorrect! Please try again.';
                errorDiv.style.display = 'block';
                
                // Reset selection after 1.5 seconds but keep them on quiz page
                setTimeout(() => {
                    options.forEach(opt => {
                        opt.classList.remove('incorrect', 'selected');
                    });
                    selectedQuizAnswer = null;
                }, 1500);
            }
        }

        // Hard difficulty puzzles - requires minimum 5 moves, red car is 2x1
        const puzzles = [
            [
                { id: 0, row: 2, col: 1, length: 2, orientation: 'horizontal', isTarget: true },
                { id: 1, row: 0, col: 0, length: 3, orientation: 'vertical' },
                { id: 2, row: 2, col: 3, length: 3, orientation: 'vertical' },
                { id: 3, row: 1, col: 3, length: 2, orientation: 'horizontal' },
                { id: 4, row: 3, col: 0, length: 2, orientation: 'horizontal' },
                { id: 5, row: 0, col: 4, length: 2, orientation: 'horizontal' },
                { id: 6, row: 4, col: 4, length: 2, orientation: 'vertical' },
                { id: 7, row: 5, col: 1, length: 3, orientation: 'horizontal' }
            ],
            [
                { id: 0, row: 2, col: 0, length: 2, orientation: 'horizontal', isTarget: true },
                { id: 1, row: 0, col: 2, length: 3, orientation: 'vertical' },
                { id: 2, row: 0, col: 3, length: 2, orientation: 'horizontal' },
                { id: 3, row: 2, col: 3, length: 3, orientation: 'vertical' },
                { id: 4, row: 1, col: 4, length: 3, orientation: 'vertical' },
                { id: 5, row: 3, col: 0, length: 2, orientation: 'horizontal' },
                { id: 6, row: 5, col: 0, length: 2, orientation: 'horizontal' },
                { id: 7, row: 4, col: 4, length: 2, orientation: 'horizontal' }
            ],
            [
                { id: 0, row: 2, col: 1, length: 2, orientation: 'horizontal', isTarget: true },
                { id: 1, row: 0, col: 0, length: 2, orientation: 'vertical' },
                { id: 2, row: 0, col: 3, length: 3, orientation: 'vertical' },
                { id: 3, row: 2, col: 0, length: 1, orientation: 'horizontal' },
                { id: 4, row: 3, col: 2, length: 2, orientation: 'vertical' },
                { id: 5, row: 1, col: 4, length: 2, orientation: 'horizontal' },
                { id: 6, row: 3, col: 4, length: 2, orientation: 'horizontal' },
                { id: 7, row: 5, col: 0, length: 3, orientation: 'horizontal' }
            ],
            [
                { id: 0, row: 2, col: 0, length: 2, orientation: 'horizontal', isTarget: true },
                { id: 1, row: 0, col: 2, length: 3, orientation: 'vertical' },
                { id: 2, row: 1, col: 0, length: 2, orientation: 'horizontal' },
                { id: 3, row: 2, col: 3, length: 2, orientation: 'vertical' },
                { id: 4, row: 0, col: 4, length: 2, orientation: 'vertical' },
                { id: 5, row: 3, col: 0, length: 3, orientation: 'horizontal' },
                { id: 6, row: 4, col: 3, length: 2, orientation: 'horizontal' },
                { id: 7, row: 5, col: 1, length: 2, orientation: 'horizontal' }
            ],
            [
                { id: 0, row: 2, col: 1, length: 2, orientation: 'horizontal', isTarget: true },
                { id: 1, row: 0, col: 1, length: 2, orientation: 'vertical' },
                { id: 2, row: 0, col: 3, length: 3, orientation: 'vertical' },
                { id: 3, row: 2, col: 4, length: 3, orientation: 'vertical' },
                { id: 4, row: 1, col: 4, length: 2, orientation: 'horizontal' },
                { id: 5, row: 4, col: 0, length: 3, orientation: 'horizontal' },
                { id: 6, row: 5, col: 3, length: 2, orientation: 'horizontal' },
                { id: 7, row: 3, col: 0, length: 1, orientation: 'horizontal' }
            ],
            [
                { id: 0, row: 2, col: 1, length: 2, orientation: 'horizontal', isTarget: true },
                { id: 1, row: 0, col: 0, length: 3, orientation: 'vertical' },
                { id: 2, row: 0, col: 2, length: 2, orientation: 'vertical' },
                { id: 3, row: 2, col: 0, length: 1, orientation: 'horizontal' },
                { id: 4, row: 2, col: 3, length: 2, orientation: 'vertical' },
                { id: 5, row: 1, col: 4, length: 2, orientation: 'horizontal' },
                { id: 6, row: 4, col: 1, length: 3, orientation: 'horizontal' },
                { id: 7, row: 5, col: 4, length: 2, orientation: 'horizontal' }
            ],
            [
                { id: 0, row: 2, col: 1, length: 2, orientation: 'horizontal', isTarget: true },
                { id: 1, row: 0, col: 1, length: 2, orientation: 'vertical' },
                { id: 2, row: 0, col: 3, length: 2, orientation: 'vertical' },
                { id: 3, row: 2, col: 3, length: 2, orientation: 'vertical' },
                { id: 4, row: 1, col: 4, length: 3, orientation: 'vertical' },
                { id: 5, row: 3, col: 0, length: 2, orientation: 'horizontal' },
                { id: 6, row: 4, col: 1, length: 3, orientation: 'horizontal' },
                { id: 7, row: 5, col: 0, length: 1, orientation: 'horizontal' }
            ],
            [
                { id: 0, row: 2, col: 0, length: 2, orientation: 'horizontal', isTarget: true },
                { id: 1, row: 0, col: 2, length: 3, orientation: 'vertical' },
                { id: 2, row: 1, col: 0, length: 2, orientation: 'horizontal' },
                { id: 3, row: 2, col: 3, length: 2, orientation: 'vertical' },
                { id: 4, row: 0, col: 4, length: 2, orientation: 'vertical' },
                { id: 5, row: 3, col: 0, length: 2, orientation: 'horizontal' },
                { id: 6, row: 4, col: 4, length: 2, orientation: 'vertical' },
                { id: 7, row: 5, col: 1, length: 3, orientation: 'horizontal' }
            ],
            [
                { id: 0, row: 2, col: 1, length: 2, orientation: 'horizontal', isTarget: true },
                { id: 1, row: 0, col: 0, length: 2, orientation: 'vertical' },
                { id: 2, row: 0, col: 3, length: 3, orientation: 'vertical' },
                { id: 3, row: 2, col: 0, length: 1, orientation: 'horizontal' },
                { id: 4, row: 3, col: 1, length: 2, orientation: 'vertical' },
                { id: 5, row: 1, col: 4, length: 2, orientation: 'horizontal' },
                { id: 6, row: 3, col: 3, length: 3, orientation: 'horizontal' },
                { id: 7, row: 5, col: 0, length: 2, orientation: 'horizontal' }
            ],
            [
                { id: 0, row: 2, col: 0, length: 2, orientation: 'horizontal', isTarget: true },
                { id: 1, row: 0, col: 1, length: 2, orientation: 'vertical' },
                { id: 2, row: 0, col: 2, length: 2, orientation: 'horizontal' },
                { id: 3, row: 2, col: 2, length: 3, orientation: 'vertical' },
                { id: 4, row: 1, col: 4, length: 2, orientation: 'vertical' },
                { id: 5, row: 3, col: 0, length: 2, orientation: 'horizontal' },
                { id: 6, row: 4, col: 4, length: 2, orientation: 'horizontal' },
                { id: 7, row: 5, col: 1, length: 2, orientation: 'horizontal' }
            ]
        ];

        function showInstructions() {
            const name = document.getElementById('modalPlayerName').value.trim();
            const team = document.getElementById('modalPlayerDepartment').value.trim();
            
            if (!name) {
                alert('Please enter your name');
                return;
            }

            if (!team) {
                alert('Please enter your team');
                return;
            }

            playerName = name;
            playerDepartment = team;

            document.getElementById('playerInfoModal').classList.remove('active');
            document.getElementById('instructionModal').classList.add('active');
        }

        function initBoard() {
            const board = document.getElementById('gameBoard');
            
            for (let i = 0; i < GRID_SIZE * GRID_SIZE; i++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                board.appendChild(cell);
            }
            
            calculateCellSize();
        }

        function loadPuzzle(puzzleIndex) {
            calculateCellSize(); // Recalculate in case of window resize
            
            const board = document.getElementById('gameBoard');
            
            document.querySelectorAll('.car').forEach(car => car.remove());
            
            const puzzle = puzzles[puzzleIndex % puzzles.length];
            cars = JSON.parse(JSON.stringify(puzzle));
            
            roundMoves = 0;
            
            cars.forEach(car => {
                const carEl = document.createElement('div');
                carEl.className = 'car';
                carEl.dataset.id = car.id;
                
                if (car.isTarget) {
                    carEl.classList.add('target');
                    carEl.textContent = 'ðŸš—';
                } else if (car.orientation === 'horizontal') {
                    carEl.classList.add('horizontal');
                    carEl.textContent = 'ðŸš™';
                } else {
                    carEl.classList.add('vertical');
                    carEl.textContent = 'ðŸš•';
                }
                
                updateCarPosition(carEl, car);
                
                carEl.addEventListener('touchstart', startDrag, { passive: false });
                carEl.addEventListener('mousedown', startDrag);
                
                board.appendChild(carEl);
            });
        }

        function updateCarPosition(carEl, car) {
            if (car.orientation === 'horizontal') {
                carEl.style.left = (car.col * CELL_SIZE + 2) + 'px';
                carEl.style.top = (car.row * CELL_SIZE + 2) + 'px';
                carEl.style.width = (car.length * CELL_SIZE - 4) + 'px';
                carEl.style.height = (CELL_SIZE - 4) + 'px';
            } else {
                carEl.style.left = (car.col * CELL_SIZE + 2) + 'px';
                carEl.style.top = (car.row * CELL_SIZE + 2) + 'px';
                carEl.style.width = (CELL_SIZE - 4) + 'px';
                carEl.style.height = (car.length * CELL_SIZE - 4) + 'px';
            }
        }

        function startDrag(e) {
            if (!gameActive) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            const carEl = e.target.closest('.car');
            if (!carEl) return;
            
            const carId = parseInt(carEl.dataset.id);
            draggedCar = cars.find(c => c.id === carId);
            
            carEl.classList.add('dragging');
            
            const touch = e.touches ? e.touches[0] : e;
            currentTouchId = e.touches ? e.touches[0].identifier : null;
            
            dragStartPos = {
                x: touch.clientX,
                y: touch.clientY,
                row: draggedCar.row,
                col: draggedCar.col
            };
            
            document.addEventListener('touchmove', drag, { passive: false });
            document.addEventListener('touchend', endDrag);
            document.addEventListener('touchcancel', endDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', endDrag);
        }

        function drag(e) {
            if (!draggedCar) return;
            
            e.preventDefault();
            
            let touch;
            if (e.touches) {
                // Find the touch that matches our currentTouchId
                for (let i = 0; i < e.touches.length; i++) {
                    if (e.touches[i].identifier === currentTouchId) {
                        touch = e.touches[i];
                        break;
                    }
                }
                if (!touch) return;
            } else {
                touch = e;
            }
            
            const deltaX = touch.clientX - dragStartPos.x;
            const deltaY = touch.clientY - dragStartPos.y;
            
            let newRow = dragStartPos.row;
            let newCol = dragStartPos.col;
            
            if (draggedCar.orientation === 'horizontal') {
                const cellsMoved = Math.round(deltaX / CELL_SIZE);
                newCol = Math.max(0, Math.min(GRID_SIZE - draggedCar.length, dragStartPos.col + cellsMoved));
            } else {
                const cellsMoved = Math.round(deltaY / CELL_SIZE);
                newRow = Math.max(0, Math.min(GRID_SIZE - draggedCar.length, dragStartPos.row + cellsMoved));
            }
            
            if (canMoveTo(draggedCar, newRow, newCol)) {
                draggedCar.row = newRow;
                draggedCar.col = newCol;
                const carEl = document.querySelector(`[data-id="${draggedCar.id}"]`);
                updateCarPosition(carEl, draggedCar);
            }
        }

        function endDrag(e) {
            if (!draggedCar) return;
            
            const carEl = document.querySelector(`[data-id="${draggedCar.id}"]`);
            if (carEl) {
                carEl.classList.remove('dragging');
            }
            
            if (draggedCar.row !== dragStartPos.row || draggedCar.col !== dragStartPos.col) {
                roundMoves++;
                totalMoves++;
                document.getElementById('moves').textContent = totalMoves;
                
                checkWin();
            }
            
            draggedCar = null;
            dragStartPos = null;
            currentTouchId = null;
            
            document.removeEventListener('touchmove', drag);
            document.removeEventListener('touchend', endDrag);
            document.removeEventListener('touchcancel', endDrag);
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', endDrag);
        }

        function canMoveTo(car, newRow, newCol) {
            for (let i = 0; i < car.length; i++) {
                const checkRow = car.orientation === 'horizontal' ? newRow : newRow + i;
                const checkCol = car.orientation === 'horizontal' ? newCol + i : newCol;
                
                for (const otherCar of cars) {
                    if (otherCar.id === car.id) continue;
                    
                    for (let j = 0; j < otherCar.length; j++) {
                        const otherRow = otherCar.orientation === 'horizontal' ? otherCar.row : otherCar.row + j;
                        const otherCol = otherCar.orientation === 'horizontal' ? otherCar.col + j : otherCar.col;
                        
                        if (checkRow === otherRow && checkCol === otherCol) {
                            return false;
                        }
                    }
                }
            }
            return true;
        }

        function checkWin() {
            const targetCar = cars.find(c => c.isTarget);
            
            // Red car (2x1) needs to reach column 4 to exit (occupies columns 4 and 5)
            if (targetCar.row === 2 && targetCar.col === 4) {
                roundComplete();
            }
        }

        function roundComplete() {
            gameActive = false;
            
            const notification = document.getElementById('roundComplete');
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
                
                score++;
                currentRound++;
                
                if (currentRound > MAX_ROUNDS || timer <= 0) {
                    endGame();
                } else {
                    document.getElementById('round').textContent = `${currentRound}/${MAX_ROUNDS}`;
                    loadPuzzle(currentRound - 1);
                    gameActive = true;
                }
            }, 1500);
        }

        function startGame() {
            document.getElementById('instructionModal').classList.remove('active');
            gameActive = true;
            gameStarted = true;
            document.getElementById('endGameBtn').style.display = 'block';
            loadPuzzle(0);
            startTimer();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timer--;
                document.getElementById('timer').textContent = timer;
                if (timer <= 0) {
                    endGame();
                }
            }, 1000);
        }

        function endGameEarly() {
            if (confirm('Are you sure you want to end the game and submit your score?')) {
                endGame();
            }
        }

        function endGame() {
            gameActive = false;
            clearInterval(timerInterval);
            document.getElementById('endGameBtn').style.display = 'none';

            const modal = document.getElementById('gameOverModal');
            const title = document.getElementById('gameOverTitle');
            const message = document.getElementById('gameOverMessage');

            title.textContent = 'ðŸŽ‰ Game Over!';
            message.textContent = `You completed ${score} round${score !== 1 ? 's' : ''} out of ${MAX_ROUNDS} with ${totalMoves} total moves!`;

            modal.classList.add('active');
        }

        function submitScoreFromModal() {
            const modal = document.getElementById('gameOverModal');
            const button = modal.querySelector('button');
            
            if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL === 'YOUR_APPS_SCRIPT_URL_HERE') {
                alert('âš ï¸ Apps Script URL not configured!\n\nPlease replace YOUR_APPS_SCRIPT_URL_HERE with your actual deployed Apps Script URL.');
                return;
            }
            
            button.disabled = true;
            button.textContent = 'Submitting...';

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = APPS_SCRIPT_URL;
            form.target = '_blank';

            const fields = {
                name: playerName,
                department: playerDepartment,
                score: score.toString(),
                totalMoves: totalMoves.toString(),
                roundsCompleted: score.toString(),
                timeRemaining: timer.toString(),
                timestamp: new Date().toISOString()
            };

            for (const [key, value] of Object.entries(fields)) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = value;
                form.appendChild(input);
            }

            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);

            button.textContent = 'Score Sent!';
            setTimeout(() => {
                modal.classList.remove('active');
                resetGame();
            }, 1500);
        }

        function resetGame() {
            currentRound = 1;
            score = 0;
            totalMoves = 0;
            roundMoves = 0;
            timer = TIME_LIMIT;
            gameActive = false;
            gameStarted = false;
            document.getElementById('timer').textContent = TIME_LIMIT;
            document.getElementById('round').textContent = `1/${MAX_ROUNDS}`;
            document.getElementById('moves').textContent = '0';
            document.getElementById('playerInfoModal').classList.add('active');
        }

        // Initialize board on load
        window.addEventListener('load', () => {
            initBoard();
        });

        // Recalculate cell size on window resize
        window.addEventListener('resize', () => {
            if (gameStarted) {
                calculateCellSize();
                cars.forEach(car => {
                    const carEl = document.querySelector(`[data-id="${car.id}"]`);
                    if (carEl) {
                        updateCarPosition(carEl, car);
                    }
                });
            }
        });

        // Prevent default touch behaviors
        document.addEventListener('touchmove', (e) => {
            if (e.target.closest('.car')) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>